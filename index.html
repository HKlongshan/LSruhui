<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>僑港順德龍山同鄉會入會申請</title>
  <script>
    // SignaturePad 庫保持不變 (內嵌代碼略...)
  </script>
  
  <style>
    /* 基礎樣式與您上傳的相同... */
    body { background-color: #fcc7bd; font-family: 'Roboto', sans-serif; padding: 20px; }
    .container { max-width: 960px; margin: 0 auto; background: white; border-top: 15px solid #f55f41; padding: 30px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    .form-group { margin-bottom: 30px; padding: 20px; border: 1px solid #dadce0; border-radius: 8px; transition: all 0.3s; }
    .required-label:after { content: " *"; color: #d93025; }
    
    /* --- 補全：閃爍提醒樣式 --- */
    @keyframes flash-red {
      0% { border-color: #dadce0; background-color: #fff; }
      50% { border-color: #ff0000; background-color: #ffeeee; }
      100% { border-color: #dadce0; background-color: #fff; }
    }
    .flash-error {
      animation: flash-red 0.5s 3;
      border: 2px solid red !important;
    }
    /* 其他樣式略... */
  </style>
</head>
<body>

<div class="container">
  </div>

<script>
  // --- 錯誤處理：跳轉並閃爍 ---
  function handleError(element, message) {
    alert(message);
    const group = element.closest('.form-group');
    if (group) {
        group.scrollIntoView({ behavior: 'smooth', block: 'center' });
        group.classList.add('flash-error');
        setTimeout(() => group.classList.remove('flash-error'), 3000);
    }
    element.focus();
  }

  async function submitForm() {
    const form = document.getElementById('memberForm');
    const msg = document.getElementById('msg');
    const btn = document.getElementById('submitBtn');

    // 1. 必填項驗證 (補全功能)
    const requiredInputs = form.querySelectorAll('[required]');
    for (let input of requiredInputs) {
        let isValid = true;
        let fieldName = input.closest('.form-group').querySelector('label').innerText.replace(' *', '');

        if (input.type === 'radio') {
            const radioGroup = form.querySelectorAll(`input[name="${input.name}"]:checked`);
            if (radioGroup.length === 0) isValid = false;
        } else if (input.type === 'checkbox') {
            if (!input.checked) isValid = false;
        } else {
            if (!input.value.trim()) isValid = false;
        }

        if (!isValid) {
            handleError(input, `請填寫或選擇必填項目：${fieldName}`);
            return;
        }
    }

    // 2. 出生日期與簽名驗證
    const y = document.getElementById('dob_y').value;
    const m = document.getElementById('dob_m').value;
    const d = document.getElementById('dob_d').value;
    if(!y || !m || !d) { handleError(document.getElementById('dob_y'), "請完整填寫出生日期"); return; }
    document.getElementById('dob_hidden').value = `${y}/${m}/${d}`;

    if(signaturePad.isEmpty()) { handleError(document.getElementById('sig-canvas'), "請在簽名區完成簽署"); return; }
    document.getElementById('signature').value = signaturePad.toDataURL();

    // 3. 開始並行提交
    btn.disabled = true;
    msg.innerText = "提交中...";

    // 生成臨時會員編號
    const now = new Date();
    const dateStr = now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
    const memberId = "LS" + dateStr + Math.floor(1000 + Math.random() * 9000);
    document.getElementById('member_id_hidden').value = memberId;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const jsonData = JSON.stringify(data);

    // --- 雙備份提交 ---
    const googleUrl = "https://script.google.com/macros/s/AKfycbzwYvy4t391KjK5CX8edd-pTCifijzXjoLFLzK8534JCl_SwrFrhqJD-a8zf-PEy_lM/exec";
    const backupUrl = "https://formspree.io/f/xbddlnzr"; // 用作國內會員的「黑匣子」備份

    const requests = [];
    // A. 提交到 Google (主庫)
    requests.push(fetch(googleUrl, { method: 'POST', body: new Blob([jsonData], {type: 'text/plain'}), mode: 'no-cors' }));
    
    // B. 提交到 備份服務 (備援庫)
    requests.push(fetch(backupUrl, {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        body: formData
    }));

    try {
        await Promise.allSettled(requests);
        alert("歡迎加入龍山同鄉會\n\n您的會員號碼為：" + memberId + "\n\n請前往秘書處繳費激活會員身份。");
        form.reset();
        signaturePad.clear();
        msg.innerText = "提交完成。";
    } catch (e) {
        alert("提交過程出現網絡問題，請聯絡秘書處。");
    } finally {
        btn.disabled = false;
    }
  }
</script>
</body>
</html>
