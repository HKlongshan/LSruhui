<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>僑港順德龍山同鄉會入會申請</title>
  <script>
    // 內嵌 SignaturePad 庫 (保持您的原版庫文件)
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).SignaturePad=e()}(this,(function(){"use strict";class t{constructor(t,e,i,s){if(isNaN(t)||isNaN(e))throw new Error(`Point is invalid: (${t}, ${e})`);this.x=+t,this.y=+e,this.pressure=i||0,this.time=s||Date.now()}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}equals(t){return this.x===t.x&&this.y===t.y&&this.pressure===t.pressure&&this.time===t.time}velocityFrom(t){return this.time!==t.time?this.distanceTo(t)/(this.time-t.time):0}}class e{static fromPoints(t,i){const s=this.calculateControlPoints(t[0],t[1],t[2]).c2,n=this.calculateControlPoints(t[1],t[2],t[3]).c1;return new e(t[1],s,n,t[2],i.start,i.end)}static calculateControlPoints(e,i,s){const n=e.x-i.x,o=e.y-i.y,r=i.x-s.x,a=i.y-s.y,h=(e.distanceTo(i)+i.distanceTo(s))/2,l=Math.sqrt(Math.pow(n,2)+Math.pow(o,2)),c=Math.sqrt(Math.pow(r,2)+Math.pow(a,2));return{c1:new t(i.x+n/l*h*.2,i.y+o/l*h*.2),c2:new t(i.x-r/c*h*.2,i.y-a/c*h*.2)}}constructor(t,e,i,s,n,o){this.startPoint=t,this.control1=e,this.control2=i,this.endPoint=s,this.startWidth=n,this.endWidth=o}length(){const t=10;let e,i,s=0;for(let n=0;n<=t;n++){const o=this.point(n/t);if(n>0){const t=o.x-e.x,n=o.y-i.y;s+=Math.sqrt(t*t+n*n)}e=o,i=o}return s}point(e){const i=e,s=i*i,n=s*i,o=1-i,r=o*o,a=r*o;return new t(a*this.startPoint.x+3*r*i*this.control1.x+3*o*s*this.control2.x+n*this.endPoint.x,a*this.startPoint.y+3*r*i*this.control1.y+3*o*s*this.control2.y+n*this.endPoint.y)}}class i{constructor(t,e={}){this.canvas=t,this.options=e,this._handleMouseDown=t=>{1===t.which&&this._strokeBegin(t)},this._handleMouseMove=t=>{this._strokeMove(t)},this._handleMouseUp=t=>{1===t.which&&this._strokeEnd(t)},this._handleTouchStart=t=>{if(1===t.targetTouches.length){const e=t.targetTouches[0];this._strokeBegin(e)}},this._handleTouchMove=t=>{if(1===t.targetTouches.length){const e=t.targetTouches[0];this._strokeMove(e)}},this._handleTouchEnd=t=>{t.target===this.canvas&&this._strokeEnd(t)},this.velocityFilterWeight=e.velocityFilterWeight||.7,this.minWidth=e.minWidth||.5,this.maxWidth=e.maxWidth||2.5,this.throttle=e.throttle||16,this.minDistance=e.minDistance||5,this.dotSize=e.dotSize||0,this.penColor=e.penColor||"black",this.backgroundColor=e.backgroundColor||"rgba(0,0,0,0)",this.onBegin=e.onBegin,this.onEnd=e.onEnd,this._ctx=t.getContext("2d"),this.clear(),this.on()}clear(){const t=this._ctx,e=this.canvas;t.fillStyle=this.backgroundColor,t.clearRect(0,0,e.width,e.height),t.fillRect(0,0,e.width,e.height),this._data=[],this._reset(),this._isEmpty=!0}toDataURL(t,e){const i=this.canvas;return i.toDataURL.apply(i,arguments)}on(){this.canvas.style.touchAction="none",this.canvas.style.msTouchAction="none",window.PointerEvent?(this.canvas.addEventListener("pointerdown",this._handleMouseDown),this.canvas.addEventListener("pointermove",this._handleMouseMove),document.addEventListener("pointerup",this._handleMouseUp)):(this.canvas.addEventListener("mousedown",this._handleMouseDown),this.canvas.addEventListener("mousemove",this._handleMouseMove),document.addEventListener("mouseup",this._handleMouseUp),this.canvas.addEventListener("touchstart",this._handleTouchStart),this.canvas.addEventListener("touchmove",this._handleTouchMove),this.canvas.addEventListener("touchend",this._handleTouchEnd))}isEmpty(){return this._isEmpty}_strokeBegin(t){const e={color:this.penColor,points:[]};this._data.push(e),this._reset(),this._strokeUpdate(t),this.onBegin&&this.onBegin(t)}async _strokeMove(t){if(0===this._lastPoints.length)return void this._strokeUpdate(t);const e=Date.now(),i=e-this._lastUpdate;i<this.throttle||(this._lastUpdate=e,this._strokeUpdate(t))}_strokeEnd(t){this._strokeUpdate(t),this.onEnd&&this.onEnd(t)}_reset(){this._lastPoints=[],this._lastVelocity=0,this._lastWidth=(this.minWidth+this.maxWidth)/2,this._ctx.fillStyle=this.penColor,this._lastUpdate=0}_strokeUpdate(t){const e=this._createPoint(t);this._addPoint(e)}_addPoint(t){const{_lastPoints:i}=this;if(i.push(t),i.length>2){3===i.length&&i.unshift(i[0]);const t=this._calculateCurveControlPoints(i[0],i[1],i[2]),s=new e(i[1],t.c2,this._calculateCurveControlPoints(i[1],i[2],i[3]).c1,i[2],this._lastWidth,this._calculateCurveWidths(i[1],i[2]).end);this._drawCurve(s),this._lastWidth=s.endWidth,i.shift()}}_calculateCurveControlPoints(i,s,n){const o=i.x-s.x,r=i.y-s.y,a=s.x-n.x,h=s.y-n.y,l=(i.distanceTo(s)+s.distanceTo(n))/2,c=Math.sqrt(Math.pow(o,2)+Math.pow(r,2)),u=Math.sqrt(Math.pow(a,2)+Math.pow(h,2));return{c1:new t(s.x+o/c*l*.2,s.y+r/c*l*.2),c2:new t(s.x-a/u*l*.2,s.y-h/u*l*.2)}}_calculateCurveWidths(t,e){const i=this.velocityFilterWeight*e.velocityFrom(t)+(1-this.velocityFilterWeight)*this._lastVelocity,s=this._strokeWidth(i),n={start:this._lastWidth,end:s};return this._lastVelocity=i,this._lastWidth=s,n}_strokeWidth(t){return Math.max(this.maxWidth/ (t+1),this.minWidth)}_drawCurveSegment(t,e,i){const s=this._ctx;s.moveTo(t,e),s.lineTo(i.x,i.y)}_drawCurve(t){const e=this._ctx,i=Math.ceil(t.length()),s=t.startWidth;for(let n=0;n<i;n++){const i=(n+1)/this.canvas.width,o=t.point(i),r=t.startWidth+(t.endWidth-t.startWidth)*i;this._drawCurveSegment(o.x,o.y,r),e.stroke()}this._isEmpty=!1}_createPoint(e){const i=this.canvas.getBoundingClientRect();return new t(e.clientX-i.left,e.clientY-i.top,e.pressure,e.time)}}return i}));
  </script>
  
  <style>
    body { background-color: #fcc7bd; font-family: 'Roboto', sans-serif; padding: 20px; margin: 0; }
    .container { max-width: 960px; margin: 0 auto; background: white; border-top: 15px solid #f55f41; padding: 30px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    h2 { text-align: center; color: #202124; margin-bottom: 30px; }
    .form-group { margin-bottom: 30px; padding: 20px; border: 1px solid #dadce0; border-radius: 8px; background-color: #fff; transition: all 0.3s; }
    label { font-size: 22px; display: block; margin-bottom: 10px; font-weight: 500; color: #202124; }
    .required-label:after { content: " *"; color: #d93025; font-size: 24px; }
    input[type="text"], input[type="tel"], input[type="email"], input[type="number"] { width: 100%; padding: 10px 0; border: none; border-bottom: 1px dotted #999; font-size: 20px; outline:none; transition: border-color 0.2s; }
    input:focus { border-bottom: 2px solid #f55f41; }
    .signature-pad-wrapper { border: 2px solid #dadce0; border-radius: 4px; background-color: #fffaf0; height: 250px; width: 100%; position: relative; }
    canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; cursor: crosshair; }
    button.submit-btn { width: 100%; max-width: 300px; padding: 18px; background-color: #9b3d2a; color: white; border: none; border-radius: 8px; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button.submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }

    /* --- 新增：必填項報錯時的閃爍效果 --- */
    @keyframes flash-red {
      0% { border-color: #dadce0; background-color: #fff; }
      50% { border-color: #ff0000; background-color: #ffeeee; }
      100% { border-color: #dadce0; background-color: #fff; }
    }
    .flash-error {
      animation: flash-red 0.5s 3;
      border: 2px solid red !important;
    }
  </style>
</head>
<body>

<div class="container">
  <img id="header-image" src="https://lh3.googleusercontent.com/d/1XyL9_V6MhLpL8I0fG4-x6Y7wzY9zG9M9" style="width:100%; border-radius: 4px;" alt="Banner">
  <h2>僑港順德龍山同鄉會 入會申請表格</h2>
  
  <form id="memberForm">
    <input type="hidden" name="member_id" id="member_id_hidden">
    
    <div class="form-group">
      <label>介紹人</label>
      <input type="text" name="referrer" placeholder="如有請填寫">
    </div>

    <div class="form-group">
      <label class="required-label">中文姓名</label>
      <input type="text" name="name_zh" required>
    </div>

    <div class="form-group">
      <label>英文姓名</label>
      <input type="text" name="name_en">
    </div>

    <div class="form-group">
      <label class="required-label">性別</label>
      <div style="display:flex; gap:30px; font-size: 20px;">
        <label style="font-weight:normal;"><input type="radio" name="gender" value="男" required> 男</label>
        <label style="font-weight:normal;"><input type="radio" name="gender" value="女"> 女</label>
      </div>
    </div>

    <div class="form-group">
      <label>年齡</label>
      <input type="number" name="age">
    </div>

    <div class="form-group">
      <label class="required-label">出生日期 (年/月/日)</label>
      <div style="display:flex; gap:10px;">
        <input type="number" id="dob_y" placeholder="YYYY" style="width:35%; text-align:center;">
        <input type="number" id="dob_m" placeholder="MM" style="width:25%; text-align:center;">
        <input type="number" id="dob_d" placeholder="DD" style="width:25%; text-align:center;">
      </div>
      <input type="hidden" name="dob" id="dob_hidden">
    </div>

    <div class="form-group">
      <label class="required-label">身份證號碼/護照號碼</label>
      <input type="text" name="id_passport" required>
    </div>

    <div class="form-group">
      <label>籍貫</label>
      <input type="text" name="native_country">
    </div>

    <div class="form-group">
      <label>職業</label>
      <input type="text" name="occupation">
    </div>

    <div class="form-group">
      <label>婚姻狀況</label>
      <input type="text" name="marital_status">
    </div>

    <div class="form-group">
      <label class="required-label">地址</label>
      <input type="text" name="address" required>
    </div>

    <div class="form-group">
      <label class="required-label">電話</label>
      <input type="tel" name="phone" required>
    </div>

    <div class="form-group">
      <label>電郵地址</label>
      <input type="email" name="email">
    </div>

    <div class="form-group">
      <label>常用通訊軟件 (如: WeChat / WhatsApp)</label>
      <input type="text" name="comm_app">
    </div>

    <div class="form-group">
      <label class="required-label">是否順德龍山區選民？</label>
      <div style="display:flex; gap:30px; font-size: 20px;">
        <label style="font-weight:normal;"><input type="radio" name="is_voter" value="是" required> 是</label>
        <label style="font-weight:normal;"><input type="radio" name="is_voter" value="否"> 否</label>
      </div>
    </div>

    <div class="form-group">
      <label class="required-label">本人簽署</label>
      <div class="signature-pad-wrapper">
        <canvas id="sig-canvas"></canvas>
      </div>
      <div style="margin-top:15px; text-align:right;">
        <button type="button" onclick="signaturePad.clear()" style="padding:8px 15px; background:#eee; border:1px solid #ccc; border-radius:4px; cursor:pointer;">清除並重簽</button>
      </div>
      <input type="hidden" name="signature" id="signature">
    </div>

    <div style="text-align: center; margin-top: 40px;">
      <button type="button" class="submit-btn" id="submitBtn" onclick="submitForm()">確認並提交</button>
      <div id="msg" style="margin-top:15px; font-weight:bold; color: #9b3d2a;"></div>
    </div>
  </form>
</div>

<script>
  // 初始化簽名板
  const canvas = document.getElementById('sig-canvas');
  const signaturePad = new SignaturePad(canvas);

  // 自動調整畫布解析度
  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  // --- 新增：錯誤處理函數（跳轉 + 閃爍） ---
  function handleError(element, message) {
    alert(message);
    const group = element.closest('.form-group');
    if (group) {
        group.scrollIntoView({ behavior: 'smooth', block: 'center' });
        group.classList.add('flash-error');
        setTimeout(() => group.classList.remove('flash-error'), 3000);
    }
    element.focus();
  }

  // --- 主提交邏輯 ---
  async function submitForm() {
    const form = document.getElementById('memberForm');
    const msg = document.getElementById('msg');
    const btn = document.getElementById('submitBtn');

    // 1. 必填項驗證
    const requiredFields = form.querySelectorAll('[required]');
    for (let field of requiredFields) {
        let isValid = true;
        let fieldName = field.closest('.form-group').querySelector('label').innerText.replace(' *', '');

        if (field.type === 'radio') {
            const radioGroup = form.querySelectorAll(`input[name="${field.name}"]:checked`);
            if (radioGroup.length === 0) isValid = false;
        } else if (field.value.trim() === "") {
            isValid = false;
        }

        if (!isValid) {
            handleError(field, `請填寫或選擇必填項目：${fieldName}`);
            return;
        }
    }

    // 2. 出生日期處理
    const y = document.getElementById('dob_y').value;
    const m = document.getElementById('dob_m').value;
    const d = document.getElementById('dob_d').value;
    if(!y || !m || !d) { 
        handleError(document.getElementById('dob_y'), "請完整填寫出生日期（年、月、日）");
        return; 
    }
    document.getElementById('dob_hidden').value = `${y}-${m}-${d}`;

    // 3. 簽名處理
    if(signaturePad.isEmpty()) { 
        handleError(canvas, "請在簽名區完成簽署");
        return;
    }
    document.getElementById('signature').value = signaturePad.toDataURL();

    // 4. 準備提交
    btn.disabled = true;
    msg.innerText = "正在進行雙重雲端備份...";

    // 生成隨機會員編號
    const now = new Date();
    const dateStr = now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
    const memberId = "LS" + dateStr + Math.floor(1000 + Math.random() * 9000);
    document.getElementById('member_id_hidden').value = memberId;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // --- 雙備份目標地址 ---
    const googleUrl = "https://script.google.com/macros/s/AKfycbzwYvy4t391KjK5CX8edd-pTCifijzXjoLFLzK8534JCl_SwrFrhqJD-a8zf-PEy_lM/exec";
    const formspreeUrl = "https://formspree.io/f/xbddlnzr"; // 您的 Formspree 連結

    // 同時啟動雙向提交
    const googlePromise = fetch(googleUrl, {
        method: 'POST',
        body: new Blob([JSON.stringify(data)], {type: 'text/plain'}),
        mode: 'no-cors'
    });

    const formspreePromise = fetch(formspreeUrl, {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        body: formData
    });

    try {
        // 等待兩邊都嘗試完成
        await Promise.allSettled([googlePromise, formspreePromise]);
        
        alert("歡迎加入龍山同鄉會！\n\n您的臨時編號為：" + memberId + "\n\n系統已完成雙重備份。");
        form.reset();
        signaturePad.clear();
        msg.innerText = "提交成功！";
    } catch (e) {
        alert("提交時發生異常，請聯繫秘書處。");
        msg.innerText = "發生錯誤。";
    } finally {
        btn.disabled = false;
    }
  }
</script>

</body>
</html>
